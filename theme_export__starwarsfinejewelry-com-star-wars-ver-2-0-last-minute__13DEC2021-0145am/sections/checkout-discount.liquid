{% assign localName = request.locale.name | handle %}
{% if section.blocks.size > 0 %}
<div id="discount-wrapper">
  {% if localName == 'english' %}
  <p class="discount-title">Apply the coupon in the box above or select from below.</p>
  {% else %}
  <p class="discount-title">上記のクーポンを使用する　又は　下記から選ぶ</p>
  {% endif %}
  <div class="discount-button-wrapper">
    <div class="discount-wrapper">
      {%- for block in section.blocks -%}
      <div class="section__discount">
        <div class="section__discount-code">
          <div class="svg-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="13.68" height="12.224" viewBox="0 0 13.68 12.224"><defs><style>.a{fill:#717171;}.b{fill:#a8a8a8;}</style></defs><g transform="translate(0 -23.224)"><g transform="translate(0 23.224)"><g transform="translate(0 0)"><path class="a" d="M10.67,23.224H6.47a1,1,0,0,0-.709.294L.294,28.984a1,1,0,0,0,0,1.419l4.2,4.2a1,1,0,0,0,1.418,0l5.467-5.466a1.006,1.006,0,0,0,.294-.71v-4.2A1,1,0,0,0,10.67,23.224ZM8.915,26.735a.752.752,0,1,1,.752-.752A.753.753,0,0,1,8.915,26.735Z" transform="translate(0 -23.224)"/></g></g><g transform="translate(6.865 24.227)"><g transform="translate(0 0)"><path class="b" d="M224.8,55.224v4.669a.871.871,0,0,1-.256.617l-5.555,5.555.085.085a1,1,0,0,0,1.418,0l5.017-5.016a1,1,0,0,0,.294-.709v-4.2A1,1,0,0,0,224.8,55.224Z" transform="translate(-218.988 -55.224)"/></g></g></g></svg>
          </div>
          <div class="discount-code-wrapper">
            <div class="code-button">
              <p class="code-off">{{ block.settings.title }} - {{ block.settings.discount_label }}</p>
              <a href="javascript:void(0);">{{ block.settings.text }}</a>
            </div>
            <div class="apply-button {{ block.settings.title }}">
              <p id="apply-discount" data-discount-code="{{ block.settings.title }}">
                {% if localName == 'english' %}
                <span>Apply</span>
                {% else %}
                <span>適応する</span>
                {% endif %}
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="19.13" height="13.018" viewBox="0 0 19.13 13.018"><defs><style>.tick-a{fill:#000;}</style></defs><g transform="translate(-15.876 -21.316)"><g transform="translate(15.876 21.316)"><path class="tick-a" d="M141.879,165.829a1.49,1.49,0,0,0-2.107-.056l-9.516,9.025-4.539-4.66a1.491,1.491,0,0,0-2.136,2.08l5.565,5.714a1.491,1.491,0,0,0,2.094.042l10.583-10.037A1.49,1.49,0,0,0,141.879,165.829Z" transform="translate(-123.158 -165.364)"/></g></g></svg>
                </span>
              </p>
            </div>
          </div>
        </div>
        <div class="section__discount-description">
          <div class="discount-details">
            <h5>{{ block.settings.terms }}</h5>
            <div class="details">
              {{ block.settings.link }}
            </div>
          </div>
        </div>
      </div>
      {%- endfor -%}
    </div>
    <button name="button" type="submit" class="field__input-btn btn btn--disabled" data-trekkie-id="apply_discount_button" aria-busy="false" disabled="disabled">
      Apply
    </button>
  </div>
</div>
{% endif %}
<script type="text/javascript">
  window.$ = Checkout.$;
  $(document).on('page:load page:change', function(){
    var discountHtml = $("#discount-wrapper").html();
    $('.order-summary__section--discount').append(discountHtml);
    
    $(document).on("click","#apply-discount",function(){
      var discountCode = $(this).data('discount-code');
      $('[name="checkout[reduction_code]"]').val(discountCode);
      $('[name="checkout[reduction_code]"]').closest('form').submit();
    });
    
    $(document).on("click",".code-button a",function(){
      $(this).fadeOut();
      $(this).closest('.section__discount').find('.section__discount-description').stop().slideDown();
    });
    
    function checkDiscountApplied(){
      $('.tags-list .tag').each(function(){
        var discountCode = $(this).find(".reduction-code__text").text();
        $('.'+discountCode).addClass('applied-discount');
      });
      $('.discount-button-wrapper .section__discount').each(function(){
        var isDiscountApplied = $(this).find(".apply-button").hasClass('applied-discount');
        if(!isDiscountApplied){
          $(this).addClass('disabled-discount');
        }
      });
    }
    
    var appliedDiscount = $(".tags-list .tag").length;
    if(appliedDiscount){
      checkDiscountApplied();
    }
    
    $(document).on('click','.tags-list .tag__wrapper .tag__button',function(e){
      //       alert();
      e.preventDefault();    
      $('form [data-trekkie-id="apply_discount_button"]').addClass("btn--loading");
      var formTag = $(this).closest('form');
      var tagUrl = $(formTag).attr("action");
      $.ajax({
        url: tagUrl,
        type: 'post',
        data: formTag.serialize(),
        success: function(response) {
          location.reload();
        }
      })
    });
    
  });
</script>
{% schema %}
  {
    "name": "Checkout discount",
    "settings": [

	],
    "blocks": [
      {
        "type": "text",
        "name": "Discount",
        "settings": [
          {
            "type": "text",
            "id": "title",
            "label": "Discount code"
          },
		  {
            "type": "text",
            "id": "discount_label",
            "label": "Discount off"
          },
		  {
            "type": "text",
            "id": "text",
            "label": "Button text"
          },
		  {
			"type": "text",
            "id": "terms",
            "label": "Discount details title",
			"default":"Terms & Conditions"
		  },
		  {
            "type": "html",
            "id": "link",
            "label": "Discount details"
          }
        ]
      }
    ]
  }
{% endschema %}

{% stylesheet %}
{% endstylesheet %}

{% javascript %}
{% endjavascript %}
